name: Test Local Direct Access

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode: local or tunnel'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - tunnel

permissions:
  contents: read
  issues: write

jobs:
  test-local-access:
    runs-on: self-hosted
    if: inputs.test_mode == 'local'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Test Direct Local Access
        id: test_local
        run: |
          echo "ðŸ” Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€ÑÐ¼Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº localhost:3000"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Cynosure Bridge Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "âœ… Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
            HEALTH=$(curl -s http://localhost:3000/health)
            echo "health_response=$HEALTH" >> $GITHUB_OUTPUT
            echo "local_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
            echo "local_status=error" >> $GITHUB_OUTPUT
          fi
          
      - name: Test Claude Request Locally
        if: steps.test_local.outputs.local_status == 'success'
        id: test_claude_local
        run: |
          echo "ðŸ¤– Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Claude Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‡ÐµÑ€ÐµÐ· localhost"
          
          RESPONSE=$(curl -s -X POST http://localhost:3000/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer test-local" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {
                  "role": "user", 
                  "content": "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð­Ñ‚Ð¾ Ñ‚ÐµÑÑ‚ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð±ÐµÐ· Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ. ÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Claude Ñ‡ÐµÑ€ÐµÐ· Cynosure Bridge."
                }
              ],
              "max_tokens": 100
            }')
          
          echo "ðŸ“ ÐžÑ‚Ð²ÐµÑ‚ Claude Ñ‡ÐµÑ€ÐµÐ· localhost:"
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            CLAUDE_RESPONSE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°"')
            echo "claude_response=$CLAUDE_RESPONSE" >> $GITHUB_OUTPUT
            echo "claude_status=success" >> $GITHUB_OUTPUT
          else
            echo "claude_status=error" >> $GITHUB_OUTPUT
          fi

  test-tunnel-access:
    runs-on: ubuntu-latest
    if: inputs.test_mode == 'tunnel'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Test Tunnel Access
        id: test_tunnel
        run: |
          echo "ðŸ” Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· ngrok Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ"
          
          TUNNEL_URL="https://45c0-85-159-229-107.ngrok-free.app"
          
          if curl -f "$TUNNEL_URL/health" > /dev/null 2>&1; then
            echo "âœ… Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: $TUNNEL_URL"
            HEALTH=$(curl -s "$TUNNEL_URL/health")
            echo "health_response=$HEALTH" >> $GITHUB_OUTPUT
            echo "tunnel_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½: $TUNNEL_URL"
            echo "tunnel_status=error" >> $GITHUB_OUTPUT
          fi
          
      - name: Test Claude Request via Tunnel
        if: steps.test_tunnel.outputs.tunnel_status == 'success'
        id: test_claude_tunnel
        run: |
          echo "ðŸ¤– Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Claude Ð·Ð°Ð¿Ñ€Ð¾Ñ Ñ‡ÐµÑ€ÐµÐ· Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ"
          
          TUNNEL_URL="https://45c0-85-159-229-107.ngrok-free.app"
          
          RESPONSE=$(curl -s -X POST "$TUNNEL_URL/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer test-tunnel" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {
                  "role": "user", 
                  "content": "ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð­Ñ‚Ð¾ Ñ‚ÐµÑÑ‚ Ñ‡ÐµÑ€ÐµÐ· ngrok Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ. ÐžÑ‚Ð²ÐµÑ‚ÑŒ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Claude Ñ‡ÐµÑ€ÐµÐ· Cynosure Bridge."
                }
              ],
              "max_tokens": 100
            }')
          
          echo "ðŸ“ ÐžÑ‚Ð²ÐµÑ‚ Claude Ñ‡ÐµÑ€ÐµÐ· Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ:"
          echo "$RESPONSE"
          
          if echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            CLAUDE_RESPONSE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°"')
            echo "claude_response=$CLAUDE_RESPONSE" >> $GITHUB_OUTPUT
            echo "claude_status=success" >> $GITHUB_OUTPUT
          else
            echo "claude_status=error" >> $GITHUB_OUTPUT
          fi

  comparison-summary:
    runs-on: ubuntu-latest
    needs: [test-local-access, test-tunnel-access]
    if: always()
    
    steps:
      - name: Create Comparison Summary
        run: |
          echo "## ðŸ” Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ: Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ vs Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ inputs.test_mode }}" == "local" ]]; then
            if [[ "${{ needs.test-local-access.outputs.local_status }}" == "success" ]]; then
              echo "âœ… **Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ: Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢**" >> $GITHUB_STEP_SUMMARY
              echo "- ÐŸÑ€ÑÐ¼Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº localhost:3000" >> $GITHUB_STEP_SUMMARY
              echo "- Ð‘ÐµÐ· Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹" >> $GITHUB_STEP_SUMMARY
              echo "- Ð‘Ñ‹ÑÑ‚Ñ€ÐµÐµ Ð¸ Ð½Ð°Ð´Ñ‘Ð¶Ð½ÐµÐµ" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ: ÐÐ• Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢**" >> $GITHUB_STEP_SUMMARY
              echo "- ÐÑƒÐ¶ÐµÐ½ self-hosted runner" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [[ "${{ needs.test-tunnel-access.outputs.tunnel_status }}" == "success" ]]; then
              echo "âœ… **Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ: Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢**" >> $GITHUB_STEP_SUMMARY
              echo "- Ð§ÐµÑ€ÐµÐ· ngrok Ñ‚ÑƒÐ½Ð½ÐµÐ»ÑŒ" >> $GITHUB_STEP_SUMMARY
              echo "- Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ ÑÐµÑ€Ð²Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
              echo "- URL Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÑÑ‚ÑŒÑÑ" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Ð¢ÑƒÐ½Ð½ÐµÐ»ÑŒ: ÐÐ• Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢**" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ (self-hosted runner)**:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ð‘Ñ‹ÑÑ‚Ñ€ÐµÐµ (Ð½ÐµÑ‚ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ÐÐ°Ð´Ñ‘Ð¶Ð½ÐµÐµ (Ð½ÐµÑ‚ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½ÐµÐµ (Ð½ÐµÑ‚ Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ÐŸÑ€Ð¾Ñ‰Ðµ (Ð½ÐµÑ‚ changeable URLs)" >> $GITHUB_STEP_SUMMARY