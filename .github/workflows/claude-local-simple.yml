name: Claude Local Simple

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Ð—Ð°Ð´Ð°Ñ‡Ð° Ð´Ð»Ñ Claude'
        required: true
        default: 'ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ'
        type: string
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ self-hosted runner (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
  claude-local:
    runs-on: self-hosted
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude-local'))
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Parse Task
        id: task
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TASK="${{ inputs.task }}"
          else
            COMMENT="${{ github.event.comment.body }}"
            TASK=$(echo "$COMMENT" | sed 's/.*@claude-local[[:space:]]*//' | head -1)
          fi
          echo "task=$TASK" >> $GITHUB_OUTPUT
          
      - name: Test Local Connection
        id: test_local
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Cynosure Bridge..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "âœ… Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
            echo "status=online" >> $GITHUB_OUTPUT
          else
            echo "âŒ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½"
            echo "ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ..."
            
            # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ‡ÐµÑ€ÐµÐ· Ñ„Ð°Ð±Ñ€Ð¸ÐºÑƒ
            if [ -f "./scripts/cynosure-factory.sh" ]; then
              ./scripts/cynosure-factory.sh start
              sleep 5
              
              if curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· Ñ„Ð°Ð±Ñ€Ð¸ÐºÑƒ"
                echo "status=online" >> $GITHUB_OUTPUT
              else
                echo "âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€"
                echo "status=offline" >> $GITHUB_OUTPUT
              fi
            else
              echo "status=offline" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: Execute Claude Request
        if: steps.test_local.outputs.status == 'online'
        id: claude
        run: |
          TASK="${{ steps.task.outputs.task }}"
          
          echo "ðŸ¤– ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ðº Claude Ñ‡ÐµÑ€ÐµÐ· localhost..."
          
          RESPONSE=$(curl -s -X POST http://localhost:3000/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer local-test" \
            -d "{
              \"model\": \"gpt-4\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"Ð¢Ñ‹ Claude, Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Cynosure Bridge Ð±ÐµÐ· Ñ‚ÑƒÐ½Ð½ÐµÐ»ÐµÐ¹. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÐ¾ Ð¸ Ð¿Ð¾Ð»ÐµÐ·Ð½Ð¾ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"$TASK\"
                }
              ],
              \"max_tokens\": 500,
              \"temperature\": 0.7
            }")
          
          echo "ðŸ“ Ð¡Ñ‹Ñ€Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚:"
          echo "$RESPONSE"
          
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Claude
          if echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            CLAUDE_RESPONSE=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚"')
            echo "response=$CLAUDE_RESPONSE" >> $GITHUB_OUTPUT
            echo "claude_status=success" >> $GITHUB_OUTPUT
          else
            echo "response=ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼" >> $GITHUB_OUTPUT
            echo "claude_status=error" >> $GITHUB_OUTPUT
          fi
          
      - name: Handle Offline Server
        if: steps.test_local.outputs.status == 'offline'
        id: offline
        run: |
          OFFLINE_RESPONSE="ðŸ”´ **Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Cynosure Bridge Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½**
          
**Ð§Ñ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ:**
1. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ‡Ñ‚Ð¾ ÑÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½: \`./scripts/cynosure-factory.sh status\`
2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€: \`./scripts/cynosure-factory.sh start\`
3. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚ 3000: \`lsof -i:3000\`

**ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:**
- âœ… ÐÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… Ñ‚ÑƒÐ½Ð½ÐµÐ»ÐµÐ¹
- âœ… Ð‘Ñ‹ÑÑ‚Ñ€ÐµÐµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ (Ð±ÐµÐ· Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ ngrok)
- âœ… Ð‘Ð¾Ð»ÐµÐµ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ð¾ (Ð½ÐµÑ‚ changeable URLs)
- âœ… Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½ÐµÐµ (Ð½ÐµÑ‚ Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°)"

          echo "response=$OFFLINE_RESPONSE" >> $GITHUB_OUTPUT
          
      - name: Post Response as Comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const task = `${{ steps.task.outputs.task }}`;
            const localStatus = `${{ steps.test_local.outputs.status }}`;
            
            let response, statusEmoji;
            
            if (localStatus === 'online') {
              response = `${{ steps.claude.outputs.response }}`;
              const claudeStatus = `${{ steps.claude.outputs.claude_status }}`;
              statusEmoji = claudeStatus === 'success' ? 'âœ…' : 'âš ï¸';
            } else {
              response = `${{ steps.offline.outputs.response }}`;
              statusEmoji = 'ðŸ”´';
            }
            
            const comment = `${statusEmoji} **Claude via Local Bridge (Ð±ÐµÐ· Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ)**

**Ð—Ð°Ð´Ð°Ñ‡Ð°:** ${task}

**ÐžÑ‚Ð²ÐµÑ‚:**
${response}

---
*ðŸ  Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ: localhost:3000*  
*ðŸš€ Status: ${localStatus}*  
*âš¡ Ð‘ÐµÐ· Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹!*`;

            const issueNumber = context.issue?.number || context.payload.pull_request?.number;
            
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: comment
              });
            }
            
      - name: Create Summary
        run: |
          echo "## ðŸ  Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Claude (Ð±ÐµÐ· Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°:** ${{ steps.test_local.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ð—Ð°Ð´Ð°Ñ‡Ð°:** ${{ steps.task.outputs.task }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test_local.outputs.status }}" = "online" ]; then
            echo "**ÐžÑ‚Ð²ÐµÑ‚ Claude:**" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.claude.outputs.response }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð° Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ:" >> $GITHUB_STEP_SUMMARY
            echo "- ÐŸÑ€ÑÐ¼Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº localhost:3000" >> $GITHUB_STEP_SUMMARY
            echo "- ÐÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ngrok Ñ‚ÑƒÐ½Ð½ÐµÐ»ÐµÐ¹" >> $GITHUB_STEP_SUMMARY
            echo "- Ð‘Ñ‹ÑÑ‚Ñ€ÐµÐµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ (Ð½ÐµÑ‚ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ñ‚ÑƒÐ½Ð½ÐµÐ»Ñ)" >> $GITHUB_STEP_SUMMARY
            echo "- Ð‘Ð¾Ð»ÐµÐµ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ð¾ (Ð½ÐµÑ‚ changeable URLs)" >> $GITHUB_STEP_SUMMARY
            echo "- Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½ÐµÐµ (Ð½ÐµÑ‚ Ð²Ð½ÐµÑˆÐ½ÐµÐ³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”§ ÐšÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "./scripts/cynosure-factory.sh start" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi